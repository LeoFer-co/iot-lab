<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>LC Projects - Dispositivos</title>
    <!-- Fuente Montserrat -->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SortableJS para drag & drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --body-bg: #1C242C;
            --header-bg: #3A4C5E;
            --accent: #D07B2C;
            --card-bg: #2A333B;
            --card-border: #424F5B;
            --text-color: #F0F0F0;
            --text-secondary: #B0B0B0;
            --offline-card-bg: #4B1E1E;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--body-bg);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: var(--header-bg);
            display: flex;
            align-items: center;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .logo {
            height: 50px;
            margin-right: 15px;
        }

        .header-title {
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--accent);
        }

        main {
            flex: 1;
            width: 100%;
            margin: 20px auto;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
        }

        h1 {
            font-size: 1.8rem;
            color: var(--accent);
            text-align: center;
            margin-bottom: 20px;
        }
        /* Tres columnas fijas por defecto */
        .device-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(280px, 1fr));
            gap: 20px;
            justify-items: center;
        }
        /* Responsividad */
        @media (max-width: 900px) {
            .device-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
        }

        .device-card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 1px 1px 4px rgba(0,0,0,0.2);
            transition: transform 0.2s ease-in-out;
            min-height: 180px;
            width: 100%;
            /* Atributo data-id para identificar la tarjeta */
        }

            .device-card:hover {
                transform: scale(1.03);
            }

        .offline-card {
            background-color: var(--offline-card-bg);
        }

        .device-card h3 {
            margin-bottom: 10px;
            color: var(--accent);
            font-size: 1.3rem;
        }

        .device-card p {
            margin: 5px 0;
            font-size: 1.05rem;
        }

        a {
            color: #5FC3E4;
            text-decoration: none;
            font-size: 1.05rem;
            font-weight: 500;
        }

            a.disabled {
                pointer-events: none;
                opacity: 0.4;
            }

        footer {
            text-align: center;
            padding: 10px 0;
            color: var(--text-secondary);
        }
        /* Clase fantasma */
        .sortable-ghost {
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <header>
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="LC Projects Logo" class="logo" />
        <h2 class="header-title">LC Projects - Dispositivos</h2>
    </header>

    <main>
        <h1>Dispositivos en la red</h1>
        <div class="device-grid" id="deviceGrid"></div>
    </main>

    <footer>
        2025 - LC Projects
    </footer>

    <script>
        let hasUserSorted = false; // para no recrear la cuadrícula si el usuario ya ordenó
        const deviceGrid = document.getElementById('deviceGrid');

        // Lee el orden guardado en localStorage (si existe)
        function getSavedOrder() {
            let orderStr = localStorage.getItem('deviceOrder');
            if (!orderStr) return null;
            try {
                return JSON.parse(orderStr);
            } catch (e) {
                return null;
            }
        }

        // Guarda el orden en localStorage
        function saveOrder(orderArray) {
            localStorage.setItem('deviceOrder', JSON.stringify(orderArray));
        }

        // Crea la tarjeta de un dispositivo
        function buildDeviceCard(dev) {
            let cardDiv = document.createElement('div');
            cardDiv.classList.add('device-card');
            // Atributo data-id con el nombre del dispositivo
            cardDiv.dataset.id = dev.device_name;

            if (dev.status_final === "Desconectado") {
                cardDiv.classList.add('offline-card');
            }
            let h3 = document.createElement('h3');
            h3.textContent = dev.device_name.charAt(0).toUpperCase() + dev.device_name.slice(1);
            cardDiv.appendChild(h3);

            let pTipo = document.createElement('p');
            pTipo.textContent = "Tipo: " + dev.device_type;
            cardDiv.appendChild(pTipo);

            let pEstado = document.createElement('p');
            pEstado.textContent = "Estado: " + dev.status_final;
            cardDiv.appendChild(pEstado);

            if (dev.status_final === "Desconectado") {
                let aDisabled = document.createElement('a');
                aDisabled.classList.add('disabled');
                aDisabled.textContent = "Ver Detalles";
                cardDiv.appendChild(aDisabled);
            } else {
                let aLink = document.createElement('a');
                aLink.href = "/device/" + dev.device_name;
                aLink.textContent = "Ver Detalles";
                cardDiv.appendChild(aLink);
            }
            return cardDiv;
        }

        // Reordena el array de dispositivos según el orden guardado
        function reorderDevices(devices, savedOrder) {
            // Filtramos para quedarnos solo con los que existen en devices
            let ordered = [];
            let deviceMap = new Map();
            devices.forEach(d => deviceMap.set(d.device_name, d));

            // Primero, añadimos en el orden guardado
            savedOrder.forEach(id => {
                if (deviceMap.has(id)) {
                    ordered.push(deviceMap.get(id));
                    deviceMap.delete(id);
                }
            });
            // Luego, añadimos los que no estaban en savedOrder
            deviceMap.forEach((val) => {
                ordered.push(val);
            });
            return ordered;
        }

        async function updateDevices() {
            if (hasUserSorted) return; // no refrescamos si el usuario reordenó manualmente

            try {
                const resp = await fetch("/devices_data");
                const devices = await resp.json();

                // Obtenemos el orden guardado
                let savedOrder = getSavedOrder();
                if (savedOrder) {
                    // Reordenamos devices según savedOrder
                    let reordered = reorderDevices(devices, savedOrder);
                    renderDevices(reordered);
                } else {
                    renderDevices(devices);
                }
            } catch (err) {
                console.error("Error al actualizar dispositivos:", err);
            }
        }

        // Renderiza las tarjetas en deviceGrid
        function renderDevices(devices) {
            deviceGrid.innerHTML = "";
            devices.forEach(dev => {
                let card = buildDeviceCard(dev);
                deviceGrid.appendChild(card);
            });
        }

        // Se actualiza cada 5s
        setInterval(updateDevices, 5000);
        updateDevices();

        // Activamos drag & drop con SortableJS
        let sortable = new Sortable(deviceGrid, {
            animation: 300,
            ghostClass: 'sortable-ghost',
            delay: 150,             // 0.15s en pantallas táctiles
            delayOnTouchOnly: true,
            onChoose: function (evt) {
                // Color neutro mientras arrastras
                evt.item.style.backgroundColor = "#FFD35F";
            },
            onUnchoose: function (evt) {
                // Si sueltas antes de mover, restaura
                evt.item.style.backgroundColor = "";
            },
            onEnd: function (evt) {
                // Al soltar la tarjeta
                evt.item.style.backgroundColor = "";
                hasUserSorted = true; // no refrescamos más desde el servidor

                // Guardamos el nuevo orden en localStorage
                let newOrder = [];
                // Recorremos los hijos de deviceGrid en el orden final
                deviceGrid.childNodes.forEach(card => {
                    newOrder.push(card.dataset.id); // device_name
                });
                saveOrder(newOrder);
            }
        });
    </script>
</body>
</html>
